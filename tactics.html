<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Dust2 äº¤äº’æˆ˜æœ¯æ¿</title>
    <style>
        :root {
            --bg-dark: #1b1b1b;
            --panel-bg: #2d2d2d;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --accent: #d39c31; /* CS2 Gold */
            --border: #404040;
            --success: #2ecc71;
            --danger: #e74c3c;
            --info: #3498db;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        header {
            background-color: var(--panel-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            z-index: 10;
        }

        .tactic-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--accent);
            color: var(--text-main);
            font-size: 1.5rem;
            text-align: center;
            width: 60%;
            padding: 5px;
            outline: none;
            font-weight: bold;
            transition: border-color 0.3s;
        }

        .tactic-input:focus {
            border-bottom-color: #fff;
        }

        /* ä¸»å¸ƒå±€æ¡†æ¶ */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden; 
        }

        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 340px; /* ç¨å¾®åŠ å®½ä»¥å®¹çº³æ“ä½œæŒ‰é’® */
            background-color: #252525;
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto; 
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar h3 {
            margin: 0 0 10px 0;
            color: var(--accent);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-group {
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        /* å­˜æ¡£åˆ—è¡¨æ ·å¼ */
        .saved-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .saved-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            padding: 8px 10px;
            border-radius: 4px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .saved-item:hover {
            background: #444;
            border-left-color: var(--accent);
        }

        .saved-name {
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            cursor: pointer;
            padding: 4px 0;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 0.9rem;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .btn-copy {
            color: var(--info);
        }
        .btn-copy:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        .btn-delete {
            color: #666;
        }
        .btn-delete:hover {
            color: var(--danger);
            background: rgba(231, 76, 60, 0.2);
        }

        .save-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .btn-save {
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }
        
        .btn-save:hover {
            background-color: #27ae60;
        }

        /* é˜Ÿå‘˜è¡Œæ ·å¼ */
        .player-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .color-picker {
            width: 30px;
            height: 30px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .input-field {
            background: transparent;
            border: 1px solid var(--border);
            color: white;
            padding: 6px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.9rem;
        }
        
        .input-field:focus {
            border-color: var(--accent);
            outline: none;
        }

        .btn-reset {
            background-color: #c0392b;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background 0.2s;
            margin-top: 10px;
        }

        .btn-reset:hover {
            background-color: #e74c3c;
        }

        /* å³ä¾§ï¼šåœ°å›¾æ»šåŠ¨åŒºåŸŸ */
        .maps-container {
            flex: 1;
            overflow-y: auto; 
            padding: 40px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px; 
            background-color: #151515;
        }

        .map-section {
            position: relative;
            width: 100%;
            max-width: 1000px;
            flex-shrink: 0; 
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: #222;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        /* å¯ç¼–è¾‘çš„é˜¶æ®µæ ‡é¢˜æ  */
        .map-header {
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            color: #ddd;
            display: flex;
            align-items: center;
        }

        /* é˜¶æ®µæ ‡é¢˜è¾“å…¥æ¡† */
        .phase-title-input {
            background: transparent;
            border: none;
            color: inherit;
            font-weight: bold;
            font-size: 1rem;
            width: 100%;
            padding: 10px 15px;
            font-family: inherit;
            cursor: text;
        }

        .phase-title-input:focus {
            outline: none;
            background: rgba(255,255,255,0.05);
        }
        
        .phase-title-input:hover {
            background: rgba(255,255,255,0.02);
        }

        .map-content-layout {
            display: flex;
            flex-direction: row;
            padding: 20px;
            gap: 20px;
            align-items: flex-start;
            justify-content: center;
        }

        .map-wrapper {
            position: relative;
            width: 100%; 
            max-width: 600px;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .game-map {
            width: 100%;
            height: auto; 
            display: block; 
            pointer-events: none;
        }

        .notes-panel {
            flex: 1;
            min-width: 250px;
            background: #1a1a1a;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .notes-title {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .notes-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 2px;
            display: block;
        }

        .notes-textarea {
            background: #111;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        @media (max-width: 950px) {
            .map-content-layout {
                flex-direction: column;
                align-items: center;
            }
            .notes-panel {
                width: 100%;
                max-width: 600px; 
            }
        }

        .token {
            position: absolute;
            width: 30px; 
            height: 30px;
            border-radius: 50%;
            background-color: #fff;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 11px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,1);
            cursor: grab;
            z-index: 100;
            transform: translate(-50%, -50%); 
            transition: transform 0.1s;
            white-space: nowrap; 
            overflow: hidden;
            user-select: none;
        }

        .token:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 200;
        }

        .token::after {
            content: '';
            position: absolute;
            top: -3px; left: -3px; right: -3px; bottom: -3px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.4);
        }

        .hidden-setting {
            display: none;
        }

    </style>
</head>
<body>

    <header>
        <input type="text" id="main-tactic-title" class="tactic-input" placeholder="è¾“å…¥æˆ˜æœ¯åç§°" value="Dust2 Strategy">
    </header>

    <div class="main-content">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <aside class="sidebar">
            
            <!-- æˆ˜æœ¯åº“åŠŸèƒ½ -->
            <div class="section-group">
                <h3>æˆ˜æœ¯è®°å¿†åº“</h3>
                <div class="save-controls">
                    <!-- ç§»é™¤äº†å·¦ä¾§å¤šä½™çš„è¾“å…¥æ¡†ï¼Œç›´æ¥ä½¿ç”¨é¡¶éƒ¨æ ‡é¢˜ -->
                    <button class="btn-save" onclick="saveStrategy()">ğŸ’¾ ä¿å­˜å½“å‰æˆ˜æœ¯</button>
                </div>
                <div style="font-size: 0.75rem; color: #888; margin-bottom: 10px;">
                    * æˆ˜æœ¯åä½¿ç”¨é¡¶éƒ¨æ ‡é¢˜
                </div>
                <div id="saved-list" class="saved-list">
                    <!-- JS ç”Ÿæˆåˆ—è¡¨é¡¹ -->
                </div>
            </div>

            <div class="section-group">
                <h3>å…¨å±€è®¾ç½®</h3>
                <div class="hidden-setting">
                    <input type="text" id="map-url-input" class="input-field" value="https://github.com/JerryZJJJ/cs2/raw/main/dust2_game_radar_1b998342f2.webp">
                </div>
                <div style="font-size: 0.8rem; color: #aaa; margin: 5px 0 5px;">é˜¶æ®µæ•°é‡:</div>
                <input type="number" id="phase-count-input" class="input-field" min="1" max="10" value="1">
            </div>

            <div class="section-group">
                <h3>é˜Ÿå‘˜åˆ—è¡¨</h3>
                <div id="player-controls">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>
            
            <div style="margin-top:auto; margin-bottom: 20px;">
                <button class="btn-reset" onclick="resetAllPositions()">é‡ç½®æ‰€æœ‰ä½ç½®</button>
            </div>
        </aside>

        <!-- å³ä¾§æ»šåŠ¨åœ°å›¾åŒº -->
        <main class="maps-container" id="maps-container">
            <!-- JS åŠ¨æ€æ’å…¥åœ°å›¾æ¿å— -->
        </main>
    </div>

    <script>
        const initialPlayers = [
            { id: 0, name: 'AWP', color: '#e74c3c' },    
            { id: 1, name: 'ä¸»B', color: '#f1c40f' },  
            { id: 2, name: 'æ”¯æŒ1', color: '#3498db' },
            { id: 3, name: 'ä¸»A', color: '#9b59b6' }, 
            { id: 4, name: 'æ”¯æŒ2', color: '#2ecc71' }     
        ];

        let players = JSON.parse(JSON.stringify(initialPlayers));
        let phaseCount = 1; 
        
        let phaseTitles = {
            1: 'Phase 1: åˆå§‹ç«™ä½ / Opening',
            2: 'Phase 2: æˆ˜æœ¯æ‰§è¡Œ / Execute',
            3: 'Phase 3: æ®‹å±€ / Post-Plant'
        };

        const STORAGE_KEY = 'cs2_tactics_saves_v1';

        function init() {
            renderControls();
            setupListeners();
            renderMaps(phaseCount); 
            loadSavedList(); 
        }

        function setupListeners() {
            document.getElementById('map-url-input').addEventListener('input', (e) => {
                updateMapImages(e.target.value);
            });

            document.getElementById('phase-count-input').addEventListener('input', (e) => {
                const val = parseInt(e.target.value, 10);
                if (val && val > 0 && val !== phaseCount) {
                    phaseCount = val;
                    renderMaps(phaseCount);
                }
            });
        }

        function updatePhaseTitle(id, newVal) {
            phaseTitles[id] = newVal;
        }

        function renderMaps(count) {
            const container = document.getElementById('maps-container');
            const currentState = gatherState(); 
            
            container.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const currentTitle = phaseTitles[i] || `Phase ${i}: é˜¶æ®µ ${i}`;
                if (!phaseTitles[i]) phaseTitles[i] = currentTitle;

                const section = document.createElement('div');
                section.className = 'map-section';
                section.innerHTML = `
                    <div class="map-header">
                        <input type="text" class="phase-title-input" 
                               value="${currentTitle}" 
                               oninput="updatePhaseTitle(${i}, this.value)">
                    </div>
                    <div class="map-content-layout">
                        <div class="map-wrapper" id="map-phase-${i}">
                            <img src="" class="game-map map-image" alt="Tactical Map">
                        </div>
                        <div class="notes-panel">
                            <div class="notes-title">æˆ˜æœ¯å¤‡æ³¨</div>
                            <label class="notes-label">é˜¶æ®µæ€è·¯</label>
                            <textarea id="note-summary-ph${i}" class="notes-textarea" rows="2" placeholder="ä¾‹å¦‚: 3-2 å¤¹Bï¼Œé“å…·è¦†ç›–ä¸­è·¯..."></textarea>
                            
                            <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                                ${players.map((p, pIdx) => `
                                    <div style="display:flex; align-items:center; margin-bottom:5px; gap:5px;">
                                        <span class="note-name-p${pIdx}" style="color:${p.color}; font-weight:bold; font-size:0.8rem; width:40px;">${p.name.substring(0,4)}</span>
                                        <input id="note-duty-ph${i}-p${pIdx}" class="input-field" style="padding:4px; font-size:0.8rem;" placeholder="èŒè´£...">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(section);
                
                const phaseData = currentState.phases && currentState.phases.find(p => p.id === i);
                renderTokensInContainer(i, phaseData ? phaseData.tokens : null);

                if (phaseData) {
                    const summaryEl = document.getElementById(`note-summary-ph${i}`);
                    if(summaryEl) summaryEl.value = phaseData.notes.summary || '';
                    
                    players.forEach((_, pIdx) => {
                        const dutyEl = document.getElementById(`note-duty-ph${i}-p${pIdx}`);
                        if(dutyEl) dutyEl.value = phaseData.notes.duties[pIdx] || '';
                    });
                }
            }
            updateMapImages(document.getElementById('map-url-input').value);
        }

        function renderTokensInContainer(phaseIndex, savedTokens) {
            const containerId = `map-phase-${phaseIndex}`;
            const container = document.getElementById(containerId);
            players.forEach((player, pIdx) => {
                const token = document.createElement('div');
                token.className = `token token-id-${pIdx}`;
                token.id = `token-ph${phaseIndex}-p${pIdx}`; 
                token.dataset.playerId = pIdx;
                updateTokenVisuals(token, player);
                
                if (savedTokens && savedTokens[pIdx]) {
                    token.style.left = savedTokens[pIdx].left;
                    token.style.top = savedTokens[pIdx].top;
                } else {
                    token.style.left = `${50 + (pIdx * 5)}%`;
                    token.style.top = `${50 + (pIdx * 5)}%`;
                }
                enableDrag(token, container);
                container.appendChild(token);
            });
        }

        function updateMapImages(url) {
            if (!url) return;
            document.querySelectorAll('.map-image').forEach(img => {
                img.src = url;
            });
        }

        function renderControls() {
            const container = document.getElementById('player-controls');
            container.innerHTML = '';
            players.forEach((player, index) => {
                const row = document.createElement('div');
                row.className = 'player-row';
                
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.className = 'color-picker';
                colorInput.value = player.color;
                colorInput.addEventListener('input', (e) => updatePlayerColor(index, e.target.value));

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'input-field';
                nameInput.value = player.name;
                nameInput.addEventListener('input', (e) => updatePlayerName(index, e.target.value));

                row.appendChild(colorInput);
                row.appendChild(nameInput);
                container.appendChild(row);
            });
        }

        function updatePlayerName(index, newName) {
            players[index].name = newName;
            const displayStr = newName.substring(0, 4).toUpperCase();
            document.querySelectorAll(`.token-id-${index}`).forEach(token => {
                token.innerText = displayStr;
                adjustTokenFontSize(token, displayStr); 
            });
            document.querySelectorAll(`.note-name-p${index}`).forEach(span => {
                span.innerText = displayStr;
            });
        }

        function updatePlayerColor(index, newColor) {
            players[index].color = newColor;
            document.querySelectorAll(`.token-id-${index}`).forEach(token => {
                token.style.backgroundColor = newColor;
            });
            document.querySelectorAll(`.note-name-p${index}`).forEach(span => {
                span.style.color = newColor;
            });
        }

        function updateTokenVisuals(element, playerData) {
            element.style.backgroundColor = playerData.color;
            const displayStr = playerData.name.substring(0, 4).toUpperCase();
            element.innerText = displayStr;
            adjustTokenFontSize(element, displayStr);
        }

        function adjustTokenFontSize(element, text) {
            if (text.length > 3) {
                element.style.fontSize = '8px';
            } else if (text.length > 2) {
                element.style.fontSize = '10px'; 
            } else {
                element.style.fontSize = '12px'; 
            }
        }

        function enableDrag(element, container) {
            let isDragging = false;
            const startDrag = (e) => {
                isDragging = true;
                element.style.zIndex = 1000;
                element.style.cursor = 'grabbing';
            };
            const endDrag = () => {
                if(isDragging) {
                    isDragging = false;
                    element.style.zIndex = 100;
                    element.style.cursor = 'grab';
                }
            };
            const doDrag = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                const rect = container.getBoundingClientRect();
                let x = clientX - rect.left;
                let y = clientY - rect.top;
                x = Math.max(0, Math.min(x, rect.width));
                y = Math.max(0, Math.min(y, rect.height));
                const xPercent = (x / rect.width) * 100;
                const yPercent = (y / rect.height) * 100;
                element.style.left = `${xPercent}%`;
                element.style.top = `${yPercent}%`;
            };
            element.addEventListener('mousedown', startDrag);
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('mousemove', doDrag);
            element.addEventListener('touchstart', startDrag, {passive: false});
            window.addEventListener('touchend', endDrag);
            window.addEventListener('touchmove', doDrag, {passive: false});
        }

        function resetAllPositions() {
            document.querySelectorAll('.token').forEach(token => {
                const pIdx = parseInt(token.dataset.playerId);
                token.style.left = `${50 + (pIdx * 5)}%`;
                token.style.top = `${50 + (pIdx * 5)}%`;
            });
        }

        // --- æ ¸å¿ƒå­˜æ¡£é€»è¾‘ ---

        function gatherState() {
            const state = {
                title: document.getElementById('main-tactic-title').value,
                players: JSON.parse(JSON.stringify(players)),
                phaseCount: phaseCount,
                phaseTitles: JSON.parse(JSON.stringify(phaseTitles)),
                phases: []
            };

            for (let i = 1; i <= phaseCount; i++) {
                const phaseData = {
                    id: i,
                    tokens: {},
                    notes: {
                        summary: '',
                        duties: {}
                    }
                };

                players.forEach((p, pIdx) => {
                    const token = document.getElementById(`token-ph${i}-p${pIdx}`);
                    if (token) {
                        phaseData.tokens[pIdx] = { left: token.style.left, top: token.style.top };
                    }
                });

                const summaryEl = document.getElementById(`note-summary-ph${i}`);
                if(summaryEl) phaseData.notes.summary = summaryEl.value;

                players.forEach((_, pIdx) => {
                    const dutyEl = document.getElementById(`note-duty-ph${i}-p${pIdx}`);
                    if(dutyEl) phaseData.notes.duties[pIdx] = dutyEl.value;
                });

                state.phases.push(phaseData);
            }
            return state;
        }

        function saveStrategy() {
            // ç›´æ¥è·å–é¡¶éƒ¨æ ‡é¢˜ä½œä¸ºæ–‡ä»¶å
            const titleInput = document.getElementById('main-tactic-title');
            const saveName = titleInput.value.trim();

            if (!saveName) {
                alert('è¯·å…ˆåœ¨é¡¶éƒ¨è¾“å…¥æˆ˜æœ¯åç§°ï¼');
                titleInput.focus();
                return;
            }

            const currentState = gatherState();
            const savedData = {
                name: saveName,
                timestamp: Date.now(),
                data: currentState
            };

            let saves = [];
            try {
                saves = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            } catch (e) { saves = []; }

            const existingIndex = saves.findIndex(s => s.name === saveName);
            if (existingIndex >= 0) {
                if(!confirm(`æˆ˜æœ¯ "${saveName}" å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) return;
                saves[existingIndex] = savedData;
            } else {
                saves.push(savedData);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(saves));
            loadSavedList(); 
        }

        // å¤åˆ¶åŠŸèƒ½
        function duplicateStrategy(originalName, event) {
            if(event) event.stopPropagation(); // é˜²æ­¢è§¦å‘åŠ è½½

            let saves = [];
            try {
                saves = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            } catch (e) { return; }

            const original = saves.find(s => s.name === originalName);
            if(!original) return;

            // ç”Ÿæˆå”¯ä¸€çš„æ–°åå­—
            let newName = originalName + "_copy";
            while (saves.some(s => s.name === newName)) {
                newName += "_copy";
            }

            const newData = JSON.parse(JSON.stringify(original.data));
            newData.title = newName; // æ›´æ–°å†…éƒ¨æ•°æ®çš„æ ‡é¢˜

            const newSave = {
                name: newName,
                timestamp: Date.now(),
                data: newData
            };

            saves.push(newSave);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saves));
            loadSavedList();
        }

        function loadSavedList() {
            const listContainer = document.getElementById('saved-list');
            listContainer.innerHTML = '';

            let saves = [];
            try {
                saves = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            } catch (e) { saves = []; }

            if (saves.length === 0) {
                listContainer.innerHTML = '<div style="color:#666; font-size:0.8rem; padding:10px; text-align:center;">æš‚æ— å­˜æ¡£</div>';
                return;
            }

            saves.sort((a, b) => b.timestamp - a.timestamp);

            saves.forEach((save) => {
                const item = document.createElement('div');
                item.className = 'saved-item';
                // åˆ—è¡¨é¡¹ç»“æ„ä¼˜åŒ–ï¼Œå¢åŠ å¤åˆ¶æŒ‰é’®
                item.innerHTML = `
                    <div class="saved-name" onclick="loadStrategy('${save.name}')">${save.name}</div>
                    <div class="item-actions">
                        <button class="btn-icon btn-copy" title="å¤åˆ¶æˆ˜æœ¯" onclick="duplicateStrategy('${save.name}', event)">â</button>
                        <button class="btn-icon btn-delete" title="åˆ é™¤" onclick="deleteStrategy('${save.name}', event)">âœ–</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }

        function loadStrategy(name) {
            let saves = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const target = saves.find(s => s.name === name);
            if (!target) return;

            const data = target.data;

            document.getElementById('main-tactic-title').value = data.title || '';
            players = data.players;
            phaseCount = data.phaseCount;
            phaseTitles = data.phaseTitles || {};

            document.getElementById('phase-count-input').value = phaseCount;
            
            renderControls();

            const container = document.getElementById('maps-container');
            container.innerHTML = ''; 

            for (let i = 1; i <= phaseCount; i++) {
                const currentTitle = phaseTitles[i] || `Phase ${i}`;
                const section = document.createElement('div');
                section.className = 'map-section';
                section.innerHTML = `
                    <div class="map-header">
                        <input type="text" class="phase-title-input" 
                               value="${currentTitle}" 
                               oninput="updatePhaseTitle(${i}, this.value)">
                    </div>
                    <div class="map-content-layout">
                        <div class="map-wrapper" id="map-phase-${i}">
                            <img src="" class="game-map map-image" alt="Tactical Map">
                        </div>
                        <div class="notes-panel">
                            <div class="notes-title">æˆ˜æœ¯å¤‡æ³¨</div>
                            <label class="notes-label">é˜¶æ®µæ€è·¯</label>
                            <textarea id="note-summary-ph${i}" class="notes-textarea" rows="2" placeholder="ä¾‹å¦‚: 3-2 å¤¹Bï¼Œé“å…·è¦†ç›–ä¸­è·¯..."></textarea>
                            
                            <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                                ${players.map((p, pIdx) => `
                                    <div style="display:flex; align-items:center; margin-bottom:5px; gap:5px;">
                                        <span class="note-name-p${pIdx}" style="color:${p.color}; font-weight:bold; font-size:0.8rem; width:40px;">${p.name.substring(0,4)}</span>
                                        <input id="note-duty-ph${i}-p${pIdx}" class="input-field" style="padding:4px; font-size:0.8rem;" placeholder="èŒè´£...">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(section);

                const phaseData = data.phases.find(p => p.id === i);
                if (phaseData) {
                    renderTokensInContainer(i, phaseData.tokens);
                    
                    const summaryEl = document.getElementById(`note-summary-ph${i}`);
                    if(summaryEl) summaryEl.value = phaseData.notes.summary || '';

                    players.forEach((_, pIdx) => {
                        const dutyEl = document.getElementById(`note-duty-ph${i}-p${pIdx}`);
                        if(dutyEl) dutyEl.value = phaseData.notes.duties[pIdx] || '';
                    });
                } else {
                    renderTokensInContainer(i, null);
                }
            }
            updateMapImages(document.getElementById('map-url-input').value);
        }

        function deleteStrategy(name, event) {
            if(event) event.stopPropagation();
            if(!confirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿ`)) return;
            let saves = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            saves = saves.filter(s => s.name !== name);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saves));
            loadSavedList();
        }

        init();

    </script>
</body>
</html>
