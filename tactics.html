<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Dust2 交互战术板</title>
    <style>
        :root {
            --bg-dark: #1b1b1b;
            --panel-bg: #2d2d2d;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --accent: #d39c31; /* CS2 Gold */
            --border: #404040;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* 防止拖拽时选中文字 */
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 防止整个页面滚动，只让地图区域滚动 */
        }

        /* 顶部标题栏 */
        header {
            background-color: var(--panel-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            z-index: 10;
        }

        .tactic-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--accent);
            color: var(--text-main);
            font-size: 1.5rem;
            text-align: center;
            width: 60%;
            padding: 5px;
            outline: none;
            font-weight: bold;
            transition: border-color 0.3s;
        }

        .tactic-input:focus {
            border-bottom-color: #fff;
        }

        /* 主布局框架 */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden; /* 关键：限制溢出 */
        }

        /* 左侧边栏：设置与队员 */
        .sidebar {
            width: 300px;
            background-color: #252525;
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto; /* 允许侧边栏独立滚动 */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar h3 {
            margin: 0 0 10px 0;
            color: var(--accent);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-group {
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        .player-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .color-picker {
            width: 30px;
            height: 30px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .input-field {
            background: transparent;
            border: 1px solid var(--border);
            color: white;
            padding: 6px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.9rem;
        }
        
        .input-field:focus {
            border-color: var(--accent);
            outline: none;
        }

        .btn-reset {
            background-color: #c0392b;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-reset:hover {
            background-color: #e74c3c;
        }

        /* 右侧：地图滚动区域 */
        .maps-container {
            flex: 1;
            overflow-y: auto; /* 允许垂直滚动 */
            padding: 40px; /* 增加整体留白 */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px; /* 板块间距 */
            background-color: #151515;
        }

        /* 单个战术阶段板块 */
        .map-section {
            position: relative;
            width: 100%;
            max-width: 1000px; /* 限制整个卡片的最大宽度 */
            flex-shrink: 0; /* 关键：防止被压缩！ */
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: #222;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .map-header {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            color: #ddd;
        }

        /* 地图+备注的布局容器 */
        .map-content-layout {
            display: flex;
            flex-direction: row;
            padding: 20px;
            gap: 20px;
            align-items: flex-start;
            justify-content: center;
        }

        /* 包裹地图图片的容器 */
        .map-wrapper {
            position: relative;
            width: 100%; 
            max-width: 600px; /* 这里控制地图显示的尺寸，600px 比较适中 */
            background: #000;
            border-radius: 4px;
            overflow: hidden; /* 防止图片圆角溢出 */
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .game-map {
            width: 100%;
            height: auto; /* 关键：自动高度，保持比例 */
            display: block; /* 消除图片底部空隙 */
            pointer-events: none;
        }

        /* 备注面板 */
        .notes-panel {
            flex: 1;
            min-width: 250px;
            background: #1a1a1a;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .notes-title {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .notes-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 2px;
            display: block;
        }

        .notes-textarea {
            background: #111;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        /* 响应式：屏幕变窄时，备注折行到地图下方 */
        @media (max-width: 950px) {
            .map-content-layout {
                flex-direction: column;
                align-items: center;
            }
            .notes-panel {
                width: 100%;
                max-width: 600px; /* 对齐地图宽度 */
            }
        }

        /* 队员 Token */
        .token {
            position: absolute;
            width: 30px; /* 稍微调小一点，显得地图大 */
            height: 30px;
            border-radius: 50%;
            background-color: #fff;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 11px; /* 默认字号 */
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,1);
            cursor: grab;
            z-index: 100;
            transform: translate(-50%, -50%); /* 居中定位 */
            transition: transform 0.1s;
            
            /* 关键修改：防止换行 */
            white-space: nowrap; 
            overflow: hidden;
        }

        .token:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 200;
        }

        /* T / CT 标记 (可选) */
        .token::after {
            content: '';
            position: absolute;
            top: -3px; left: -3px; right: -3px; bottom: -3px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.4);
        }

        /* 辅助类：隐藏元素 */
        .hidden-setting {
            display: none;
        }

    </style>
</head>
<body>

    <header>
        <input type="text" class="tactic-input" placeholder="输入战术名称 (例: Dust2 Mid Split)" value="Dust2 Strategy">
    </header>

    <div class="main-content">
        <!-- 左侧控制面板 -->
        <aside class="sidebar">
            
            <div class="section-group">
                <h3>全局设置</h3>
                
                <!-- 地图 URL 输入区域：已隐藏 -->
                <div class="hidden-setting">
                    <div style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px;">地图 URL:</div>
                    <input type="text" id="map-url-input" class="input-field" value="https://github.com/JerryZJJJ/cs2/raw/main/dust2_game_radar_1b998342f2.webp">
                    <div style="margin-top:5px; font-size: 0.75rem; color: #666;">
                        * 自动适配任何比例的地图图片
                    </div>
                </div>

                <div style="font-size: 0.8rem; color: #aaa; margin: 5px 0 5px;">阶段数量:</div>
                <input type="number" id="phase-count-input" class="input-field" min="1" max="10" value="1">
            </div>

            <div class="section-group">
                <h3>队员列表</h3>
                <div id="player-controls">
                    <!-- JS 生成 -->
                </div>
            </div>
            
            <div style="margin-top:auto; margin-bottom: 20px;">
                <button class="btn-reset" onclick="resetAllPositions()">重置所有位置</button>
            </div>
        </aside>

        <!-- 右侧滚动地图区 -->
        <main class="maps-container" id="maps-container">
            <!-- JS 动态插入地图板块 -->
        </main>
    </div>

    <script>
        // 配置：恢复之前的默认中文名
        const initialPlayers = [
            { id: 0, name: 'AWP', color: '#e74c3c' },    
            { id: 1, name: '主B', color: '#f1c40f' },  
            { id: 2, name: '支持1', color: '#3498db' },
            { id: 3, name: '主A', color: '#9b59b6' }, 
            { id: 4, name: '支持2', color: '#2ecc71' }     
        ];

        let players = JSON.parse(JSON.stringify(initialPlayers));
        let phaseCount = 1; // 修改默认阶段数为 1

        // 初始化
        function init() {
            renderControls();
            setupListeners();
            renderMaps(phaseCount); // 初始渲染
        }

        function setupListeners() {
            // 地图URL监听 (虽然UI隐藏了，但逻辑保留)
            document.getElementById('map-url-input').addEventListener('input', (e) => {
                updateMapImages(e.target.value);
            });

            // 阶段数量监听
            document.getElementById('phase-count-input').addEventListener('input', (e) => {
                const val = parseInt(e.target.value, 10);
                if (val && val > 0 && val !== phaseCount) {
                    phaseCount = val;
                    renderMaps(phaseCount);
                }
            });
        }

        function getPhaseTitle(index) {
            if (index === 1) return 'Phase 1: 初始站位 / Opening';
            if (index === 2) return 'Phase 2: 战术执行 / Execute';
            if (index === 3) return 'Phase 3: 残局 / Post-Plant';
            return `Phase ${index}: 阶段 ${index}`;
        }

        // 重新渲染所有地图板块
        function renderMaps(count) {
            const container = document.getElementById('maps-container');
            
            // 暂存旧数据逻辑
            const oldTokens = {}; 
            document.querySelectorAll('.token').forEach(t => {
                oldTokens[t.id] = { left: t.style.left, top: t.style.top };
            });

            container.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const section = document.createElement('div');
                section.className = 'map-section';
                
                // HTML 结构
                section.innerHTML = `
                    <div class="map-header">${getPhaseTitle(i)}</div>
                    <div class="map-content-layout">
                        <div class="map-wrapper" id="map-phase-${i}">
                            <img src="" class="game-map map-image" alt="Tactical Map">
                            <!-- Tokens inserted here -->
                        </div>
                        
                        <div class="notes-panel">
                            <div class="notes-title">战术备注</div>
                            <label class="notes-label">阶段思路</label>
                            <textarea class="notes-textarea" rows="2" placeholder="例如: 3-2 夹B，道具覆盖中路..."></textarea>
                            
                            <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                                ${players.map((p, pIdx) => `
                                    <div style="display:flex; align-items:center; margin-bottom:5px; gap:5px;">
                                        <!-- 给名字加上class，方便后续查找更新 -->
                                        <span class="note-name-p${pIdx}" style="color:${p.color}; font-weight:bold; font-size:0.8rem; width:40px;">${p.name.substring(0,3)}</span>
                                        <input class="input-field" style="padding:4px; font-size:0.8rem;" placeholder="职责...">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(section);
                
                // 插入 Token
                renderTokensInContainer(i, oldTokens);
            }

            // 重新应用图片链接
            updateMapImages(document.getElementById('map-url-input').value);
        }

        function renderTokensInContainer(phaseIndex, savedPositions) {
            const containerId = `map-phase-${phaseIndex}`;
            const container = document.getElementById(containerId);
            
            players.forEach((player, pIdx) => {
                const token = document.createElement('div');
                token.className = `token token-id-${pIdx}`;
                token.id = `token-ph${phaseIndex}-p${pIdx}`; // 唯一ID
                token.dataset.playerId = pIdx;

                updateTokenVisuals(token, player);

                // 恢复位置 或 设置默认位置
                if (savedPositions && savedPositions[token.id]) {
                    token.style.left = savedPositions[token.id].left;
                    token.style.top = savedPositions[token.id].top;
                } else {
                    // 默认散开一点
                    token.style.left = `${50 + (pIdx * 5)}%`;
                    token.style.top = `${50 + (pIdx * 5)}%`;
                }

                enableDrag(token, container);
                container.appendChild(token);
            });
        }

        function updateMapImages(url) {
            if (!url) return;
            document.querySelectorAll('.map-image').forEach(img => {
                img.src = url;
            });
        }

        // --- 左侧控制逻辑 ---
        function renderControls() {
            const container = document.getElementById('player-controls');
            container.innerHTML = '';
            players.forEach((player, index) => {
                const row = document.createElement('div');
                row.className = 'player-row';
                
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.className = 'color-picker';
                colorInput.value = player.color;
                colorInput.addEventListener('input', (e) => updatePlayerColor(index, e.target.value));

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'input-field';
                nameInput.value = player.name;
                nameInput.addEventListener('input', (e) => updatePlayerName(index, e.target.value));

                row.appendChild(colorInput);
                row.appendChild(nameInput);
                container.appendChild(row);
            });
        }

        function updatePlayerName(index, newName) {
            players[index].name = newName;
            const displayStr = newName.substring(0, 3).toUpperCase();

            // 1. 更新地图上的 Token 文字
            document.querySelectorAll(`.token-id-${index}`).forEach(token => {
                token.innerText = displayStr;
                adjustTokenFontSize(token, displayStr); // 更新文字时也检测字号
            });
            
            // 2. 实时更新备注栏里的名字
            document.querySelectorAll(`.note-name-p${index}`).forEach(span => {
                span.innerText = displayStr;
            });
        }

        function updatePlayerColor(index, newColor) {
            players[index].color = newColor;

            // 1. 更新地图上的 Token 颜色
            document.querySelectorAll(`.token-id-${index}`).forEach(token => {
                token.style.backgroundColor = newColor;
            });

            // 2. 实时更新备注栏里的名字颜色
            document.querySelectorAll(`.note-name-p${index}`).forEach(span => {
                span.style.color = newColor;
            });
        }

        function updateTokenVisuals(element, playerData) {
            element.style.backgroundColor = playerData.color;
            const displayStr = playerData.name.substring(0, 3).toUpperCase();
            element.innerText = displayStr;
            adjustTokenFontSize(element, displayStr); // 初始化时检测字号
        }

        // 新增：自适应字号逻辑
        function adjustTokenFontSize(element, text) {
            if (text.length > 2) {
                element.style.fontSize = '9px'; // 字符多时，缩小字号
            } else {
                element.style.fontSize = '11px'; // 默认字号
            }
        }

        // --- 拖拽核心 ---
        function enableDrag(element, container) {
            let isDragging = false;
            
            const startDrag = (e) => {
                isDragging = true;
                element.style.zIndex = 1000;
                element.style.cursor = 'grabbing';
            };

            const endDrag = () => {
                if(isDragging) {
                    isDragging = false;
                    element.style.zIndex = 100;
                    element.style.cursor = 'grab';
                }
            };

            const doDrag = (e) => {
                if (!isDragging) return;
                e.preventDefault();

                // 兼容触摸和鼠标
                const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);

                const rect = container.getBoundingClientRect();

                // 计算相对于容器的坐标
                let x = clientX - rect.left;
                let y = clientY - rect.top;

                // 边界限制
                x = Math.max(0, Math.min(x, rect.width));
                y = Math.max(0, Math.min(y, rect.height));

                // 转换为百分比
                const xPercent = (x / rect.width) * 100;
                const yPercent = (y / rect.height) * 100;

                element.style.left = `${xPercent}%`;
                element.style.top = `${yPercent}%`;
            };

            element.addEventListener('mousedown', startDrag);
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('mousemove', doDrag);

            element.addEventListener('touchstart', startDrag, {passive: false});
            window.addEventListener('touchend', endDrag);
            window.addEventListener('touchmove', doDrag, {passive: false});
        }

        function resetAllPositions() {
            document.querySelectorAll('.token').forEach(token => {
                const pIdx = parseInt(token.dataset.playerId);
                token.style.left = `${50 + (pIdx * 5)}%`;
                token.style.top = `${50 + (pIdx * 5)}%`;
            });
        }

        // 启动
        init();

    </script>
</body>
</html>